/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$isDecoratorNode as e,$getNodeByKey as t,$isLineBreakNode as n,$isTextNode as o,$getSelection as s,$isRangeSelection as i,$isElementNode as r,$getNodeByKeyOrThrow as l,removeFromParent as c,createEditor as a,$isRootNode as f,$getWritableNodeState as d,$getRoot as u,RootNode as h,ElementNode as p,TextNode as g,$getState as _,createState as y,COLLABORATION_TAG as m,HISTORIC_TAG as x,$addUpdateTag as T,SKIP_SCROLL_INTO_VIEW_TAG as b,$createParagraphNode as k,createCommand as S}from"lexical";import{XmlText as N,XmlElement as v,Map as w,Doc as C,typeListToArraySnapshot as O,Snapshot as K,isDeleted as M,XmlHook as E,ContentString as P,ContentFormat as F,snapshot as A,emptySnapshot as j,PermanentUserData as z,iterateDeletedStructs as L,createAbsolutePositionFromRelativePosition as D,createRelativePositionFromTypeIndex as Y,compareRelativePositions as I,Item as $,YMapEvent as W,YTextEvent as U,YXmlEvent as R,UndoManager as B}from"yjs";import{$createChildrenArray as q}from"@lexical/offset";import{createDOMRange as J,createRectsFromDOMRange as G}from"@lexical/selection";function V(e,...t){const n=new URL("https://lexical.dev/docs/error"),o=new URLSearchParams;o.append("code",e);for(const e of t)o.append("v",e);throw n.search=o.toString(),Error(`Minified Lexical error #${e}; visit ${n.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}function H(e,t,n){const o=e.length,s=t.length;let i=0,r=0;for(;i<o&&i<s&&e[i]===t[i]&&i<n;)i++;for(;r+i<o&&r+i<s&&e[o-r-1]===t[s-r-1];)r++;for(;r+i<o&&r+i<s&&e[i]===t[i];)i++;return{index:i,insert:t.slice(i,s-r),remove:o-i-r}}class Q{_xmlElem;_key;_parent;_type;constructor(e,t,n){this._key="",this._xmlElem=e,this._parent=t,this._type=n}getPrevNode(t){if(null===t)return null;const n=t.get(this._key);return e(n)?n:null}getNode(){const n=t(this._key);return e(n)?n:null}getSharedType(){return this._xmlElem}getType(){return this._type}getKey(){return this._key}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}syncPropertiesFromLexical(e,t,n){const o=this.getPrevNode(n);Ne(e,this._xmlElem,o,t)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&V(83);Te(e,this._xmlElem,n,t)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function X(e,t,n){const o=new Q(e,t,n);return e._collabNode=o,o}class Z{_map;_key;_parent;_type;constructor(e,t){this._key="",this._map=e,this._parent=t,this._type="linebreak"}getNode(){const e=t(this._key);return n(e)?e:null}getKey(){return this._key}getSharedType(){return this._map}getType(){return this._type}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function ee(e,t){const n=new Z(e,t);return e._collabNode=n,n}class te{_map;_key;_parent;_text;_type;_normalized;constructor(e,t,n,o){this._key="",this._map=e,this._parent=n,this._text=t,this._type=o,this._normalized=!1}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return o(t)?t:null}getNode(){const e=t(this._key);return o(e)?e:null}getSharedType(){return this._map}getType(){return this._type}getKey(){return this._key}getSize(){return this._text.length+(this._normalized?0:1)}getOffset(){return this._parent.getChildOffset(this)}spliceText(e,t,n){const o=this._parent._xmlText,s=this.getOffset()+1+e;0!==t&&o.delete(s,t),""!==n&&o.insert(s,n)}syncPropertiesAndTextFromLexical(e,t,n){const o=this.getPrevNode(n),r=t.__text;if(Ne(e,this._map,o,t),null!==o){const e=o.__text;if(e!==r){!function(e,t,n,o){const r=s();let l=o.length;if(i(r)&&r.isCollapsed()){const e=r.anchor;e.key===t&&(l=e.offset)}const c=H(n,o,l);e.spliceText(c.index,c.remove,c.insert)}(this,t.__key,e,r),this._text=r}}}syncPropertiesAndTextFromYjs(e,t){const n=this.getNode();null===n&&V(84),Te(e,this._map,n,t);const o=this._text;n.__text!==o&&n.setTextContent(o)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function ne(e,t,n,o){const s=new te(e,t,n,o);return e._collabNode=s,s}class oe{_key;_children;_xmlText;_type;_parent;constructor(e,t,n){this._key="",this._children=[],this._xmlText=e,this._type=n,this._parent=t}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return r(t)?t:null}getNode(){const e=t(this._key);return r(e)?e:null}getSharedType(){return this._xmlText}getType(){return this._type}getKey(){return this._key}isEmpty(){return 0===this._children.length}getSize(){return 1}getOffset(){const e=this._parent;return null===e&&V(90),e.getChildOffset(this)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&V(91),Te(e,this._xmlText,n,t)}applyChildrenYjsDelta(e,t){const n=this._children;let o=0,s=null;for(let i=0;i<t.length;i++){const r=t[i],l=r.insert,c=r.delete;if(null!=r.retain)o+=r.retain;else if("number"==typeof c){let e=c;for(;e>0;){const{node:t,nodeIndex:s,offset:i,length:r}=we(this,o,!1);if(t instanceof oe||t instanceof Z||t instanceof Q)n.splice(s,1),e-=1;else{if(!(t instanceof te))break;{const o=Math.min(e,r),l=0!==s?n[s-1]:null,c=t.getSize();if(0===i&&r===c){n.splice(s,1);const e=ve(t._text,i,o-1,"");e.length>0&&(l instanceof te?l._text+=e:this._xmlText.delete(i,e.length))}else t._text=ve(t._text,i,o,"");e-=o}}}}else{if(null==l)throw new Error("Unexpected delta format");if("string"==typeof l){const{node:e,offset:t}=we(this,o,!0);e instanceof te?e._text=ve(e._text,t,0,l):this._xmlText.delete(t,l.length),o+=l.length}else{const t=l,{node:i,nodeIndex:r,length:c}=we(this,o,!1),a=me(e,t,this);if(i instanceof te&&c>0&&c<i._text.length){const e=i._text,t=e.length-c;i._text=ve(e,t,c,""),n.splice(r+1,0,a),s=ve(e,0,t,"")}else n.splice(r,0,a);null!==s&&a instanceof te&&(a._text=s+a._text,s=null),o+=1}}}}syncChildrenFromYjs(e){const t=this.getNode();null===t&&V(92);const n=t.__key,s=q(t,null),i=s.length,r=this._children,a=r.length,f=e.collabNodeMap,d=new Set;let u,h,p=0,g=null;a!==i&&(h=t.getWritable());for(let i=0;i<a;i++){const _=s[p],y=r[i],m=y.getNode(),x=y._key;if(null!==m&&_===x){const t=o(m);if(d.add(_),t)if(y._key=_,y instanceof oe){const t=y._xmlText;y.syncPropertiesFromYjs(e,null),y.applyChildrenYjsDelta(e,t.toDelta()),y.syncChildrenFromYjs(e)}else y instanceof te?y.syncPropertiesAndTextFromYjs(e,null):y instanceof Q?y.syncPropertiesFromYjs(e,null):y instanceof Z||V(93);g=m,p++}else{if(void 0===u){u=new Set;for(let e=0;e<a;e++){const t=r[e]._key;""!==t&&u.add(t)}}if(null!==m&&void 0!==_&&!u.has(_)){const e=l(_);c(e),i--,p++;continue}h=t.getWritable();const o=xe(e,y,n),s=o.__key;if(f.set(s,y),null===g){const e=h.getFirstChild();if(h.__first=s,null!==e){const t=e.getWritable();t.__prev=s,o.__next=t.__key}}else{const e=g.getWritable(),t=g.getNextSibling();if(e.__next=s,o.__prev=g.__key,null!==t){const e=t.getWritable();e.__prev=s,o.__next=e.__key}}i===a-1&&(h.__last=s),h.__size++,g=o}}for(let t=0;t<i;t++){const n=s[t];if(!d.has(n)){const t=l(n),o=e.collabNodeMap.get(n);void 0!==o&&o.destroy(e),c(t)}}}syncPropertiesFromLexical(e,t,n){Ne(e,this._xmlText,this.getPrevNode(n),t)}_syncChildFromLexical(t,n,s,i,c,a){const f=this._children[n],d=l(s);f instanceof oe&&r(d)?(f.syncPropertiesFromLexical(t,d,i),f.syncChildrenFromLexical(t,d,i,c,a)):f instanceof te&&o(d)?f.syncPropertiesAndTextFromLexical(t,d,i):f instanceof Q&&e(d)&&f.syncPropertiesFromLexical(t,d,i)}syncChildrenFromLexical(e,t,n,o,s){const i=this.getPrevNode(n),r=null===i?[]:q(i,n),c=q(t,null),a=r.length-1,f=c.length-1,d=e.collabNodeMap;let u,h,p=0,g=0;for(;p<=a&&g<=f;){const t=r[p],i=c[g];if(t===i)this._syncChildFromLexical(e,g,i,n,o,s),p++,g++;else{void 0===u&&(u=new Set(r)),void 0===h&&(h=new Set(c));const n=h.has(t),o=u.has(i);if(n){const t=_e(e,l(i),this);d.set(i,t),o?(this.splice(e,g,1,t),p++,g++):(this.splice(e,g,0,t),g++)}else this.splice(e,g,1),p++}}const _=p>a,y=g>f;if(_&&!y)for(;g<=f;++g){const t=c[g],n=_e(e,l(t),this);this.append(n),d.set(t,n)}else if(y&&!_)for(let t=this._children.length-1;t>=g;t--)this.splice(e,t,1)}append(e){const t=this._xmlText,n=this._children,o=n[n.length-1],s=void 0!==o?o.getOffset()+o.getSize():0;if(e instanceof oe)t.insertEmbed(s,e._xmlText);else if(e instanceof te){const n=e._map;null===n.parent&&t.insertEmbed(s,n),t.insert(s+1,e._text)}else e instanceof Z?t.insertEmbed(s,e._map):e instanceof Q&&t.insertEmbed(s,e._xmlElem);this._children.push(e)}splice(e,t,n,o){const s=this._children,i=s[t];if(void 0===i)return void 0===o&&V(94),void this.append(o);const r=i.getOffset();-1===r&&V(95);const l=this._xmlText;if(0!==n&&l.delete(r,i.getSize()),o instanceof oe)l.insertEmbed(r,o._xmlText);else if(o instanceof te){const e=o._map;null===e.parent&&l.insertEmbed(r,e),l.insert(r+1,o._text)}else o instanceof Z?l.insertEmbed(r,o._map):o instanceof Q&&l.insertEmbed(r,o._xmlElem);if(0!==n){const o=s.slice(t,t+n);for(let t=0;t<o.length;t++)o[t].destroy(e)}void 0!==o?s.splice(t,n,o):s.splice(t,n)}getChildOffset(e){let t=0;const n=this._children;for(let o=0;o<n.length;o++){const s=n[o];if(s===e)return t;t+=s.getSize()}return-1}destroy(e){const t=e.collabNodeMap,n=this._children;for(let t=0;t<n.length;t++)n[t].destroy(e);t.get(this._key)===this&&t.delete(this._key)}}function se(e,t,n){const o=new oe(e,t,n);return e._collabNode=o,o}class ie{_nodeMap=new Map;_sharedTypeToNodeKeys=new Map;_nodeKeyToSharedType=new Map;set(e,t){const n=t instanceof Array;this.delete(e);const s=n?t:[t];for(const e of s){const t=e.getKey();if(this._nodeKeyToSharedType.has(t)){const e=this._nodeKeyToSharedType.get(t),n=this._sharedTypeToNodeKeys.get(e).indexOf(t);-1!==n&&this._sharedTypeToNodeKeys.get(e).splice(n,1),this._nodeKeyToSharedType.delete(t),this._nodeMap.delete(t)}}if(e instanceof N){if(n||V(331),0===t.length)return;this._sharedTypeToNodeKeys.set(e,t.map(e=>e.getKey()));for(const n of t)this._nodeMap.set(n.getKey(),n),this._nodeKeyToSharedType.set(n.getKey(),e)}else n&&V(332),o(t)&&V(333),this._sharedTypeToNodeKeys.set(e,[t.getKey()]),this._nodeMap.set(t.getKey(),t),this._nodeKeyToSharedType.set(t.getKey(),e)}get(e){const t=this._sharedTypeToNodeKeys.get(e);if(void 0!==t){if(e instanceof N){const e=Array.from(t.map(e=>this._nodeMap.get(e)));return e.length>0?e:void 0}return this._nodeMap.get(t[0])}}getSharedType(e){return this._nodeKeyToSharedType.get(e.getKey())}delete(e){const t=this._sharedTypeToNodeKeys.get(e);if(void 0!==t){for(const e of t)this._nodeMap.delete(e),this._nodeKeyToSharedType.delete(e);this._sharedTypeToNodeKeys.delete(e)}}deleteNode(e){const t=this._nodeKeyToSharedType.get(e);t&&this.delete(t),this._nodeMap.delete(e)}has(e){return this._sharedTypeToNodeKeys.has(e)}clear(){this._nodeMap.clear(),this._sharedTypeToNodeKeys.clear(),this._nodeKeyToSharedType.clear()}}function re(e,t,n,o,s){null==n&&V(81);const i={clientID:n.clientID,cursors:new Map,cursorsContainer:null,doc:n,docMap:o,editor:e,excludedProperties:s||new Map,id:t,nodeProperties:new Map};return function(e){const{editor:t,nodeProperties:n}=e;t.update(()=>{t._nodes.forEach(t=>{const o=new t.klass,s={};for(const[t,n]of Object.entries(o))pe(t,o,e)||(s[t]=n);n.set(o.__type,Object.freeze(s))})})}(i),i}function le(e,t,n,o,s,i){null==o&&V(81);const r=se(o.get("root",N),null,"root");return r._key="root",{...re(e,n,o,s,i),collabNodeMap:new Map,root:r}}function ce(e,t,n,o,s={}){null==n&&V(81);const{excludedProperties:i,rootName:r="root-v2"}=s;return{...re(e,t,n,o,i),mapping:new ie,root:n.get(r,v)}}function ae(e){return Object.hasOwn(e,"collabNodeMap")}const fe=new Set(["__key","__parent","__next","__prev","__state"]),de=new Set(["__first","__last","__size"]),ue=new Set(["__cachedText"]),he=new Set(["__text"]);function pe(e,t,n){if(fe.has(e)||"function"==typeof t[e])return!0;if(o(t)){if(he.has(e))return!0}else if(r(t)&&(de.has(e)||f(t)&&ue.has(e)))return!0;const s=t.constructor,i=n.excludedProperties.get(s);return null!=i&&i.has(e)}function ge(e,t){const n=e.__type,{nodeProperties:o}=t,s=o.get(n);return void 0===s&&V(330,n),s}function _e(t,s,i){const l=s.__type;let c;if(r(s)){c=se(new N,i,l),c.syncPropertiesFromLexical(t,s,null),c.syncChildrenFromLexical(t,s,null,null,null)}else if(o(s)){c=ne(new w,s.__text,i,l),c.syncPropertiesAndTextFromLexical(t,s,null)}else if(n(s)){const e=new w;e.set("__type","linebreak"),c=ee(e,i)}else if(e(s)){c=X(new v,i,l),c.syncPropertiesFromLexical(t,s,null)}else V(86);return c._key=s.__key,c}function ye(e){const t=be(e,"__type");return"string"!=typeof t&&void 0!==t&&V(87),t}function me(e,t,n){const o=t._collabNode;if(void 0===o){const o=e.editor._nodes,s=ye(t);"string"!=typeof s&&V(87);void 0===o.get(s)&&V(88,s);const i=t.parent,r=void 0===n&&null!==i?me(e,i):n||null;if(r instanceof oe||V(89),t instanceof N)return se(t,r,s);if(t instanceof w)return"linebreak"===s?ee(t,r):ne(t,"",r,s);if(t instanceof v)return X(t,r,s)}return o}function xe(e,t,n){const o=t.getType(),s=e.editor._nodes.get(o);void 0===s&&V(88,o);const i=new s.klass;if(i.__parent=n,t._key=i.__key,t instanceof oe){const n=t._xmlText;t.syncPropertiesFromYjs(e,null),t.applyChildrenYjsDelta(e,n.toDelta()),t.syncChildrenFromYjs(e)}else t instanceof te?t.syncPropertiesAndTextFromYjs(e,null):t instanceof Q&&t.syncPropertiesFromYjs(e,null);return e.collabNodeMap.set(i.__key,t),i}function Te(e,t,n,o){const s=null===o?t instanceof w?Array.from(t.keys()):t instanceof N||t instanceof v?Object.keys(t.getAttributes()):Object.keys(t):Array.from(o);let i;for(let o=0;o<s.length;o++){const r=s[o];if(pe(r,n,e)){"__state"===r&&ae(e)&&(i||(i=n.getWritable()),Se(t,i));continue}const l=n[r];let c=be(t,r);if(l!==c){if(c instanceof C){const t=e.docMap;l instanceof C&&t.delete(l.guid);const n=a(),o=c.guid;n._key=o,t.set(o,c),c=n}void 0===i&&(i=n.getWritable()),i[r]=c}}}function be(e,t){return e instanceof w?e.get(t):e instanceof N||e instanceof v?e.getAttribute(t):e[t]}function ke(e,t,n){e instanceof w?e.set(t,n):e.setAttribute(t,n)}function Se(e,t){const n=be(e,"__state");n instanceof w&&d(t).updateFromJSON(n.toJSON())}function Ne(e,t,n,o){const s=Object.keys(ge(o,e)),i=e.editor.constructor;!function(e,t,n,o){const s=o.__state,i=be(t,"__state");if(!s)return;const[r,l]=s.getInternalState(),c=n&&n.__state,a=i instanceof w?i:new w;if(c===s)return;const[f,d]=c&&a.doc?c.getInternalState():[void 0,new Map];if(r)for(const[e,t]of Object.entries(r))f&&t!==f[e]&&a.set(e,t);for(const[e,t]of l)d.get(e)!==t&&a.set(e.key,e.unparse(t));i||ke(t,"__state",a)}(0,t,n,o);for(let r=0;r<s.length;r++){const l=s[r],c=null===n?void 0:n[l];let a=o[l];if(c!==a){if(a instanceof i){const t=e.docMap;let n;if(c instanceof i){const e=c._key;n=t.get(e),t.delete(e)}const s=n||new C,r=s.guid;a._key=r,t.set(r,s),a=s,e.editor.update(()=>{o.markDirty()})}ke(t,l,a)}}}function ve(e,t,n,o){return e.slice(0,t)+o+e.slice(t+n)}function we(e,t,n){let o=0,s=0;const i=e._children,r=i.length;for(;s<r;s++){const e=i[s],l=o;o+=e.getSize();if((n?o>=t:o>t)&&e instanceof te){let n=t-l-1;n<0&&(n=0);return{length:o-t,node:e,nodeIndex:s,offset:n}}if(o>t)return{length:0,node:e,nodeIndex:s,offset:l};if(s===r-1)return{length:0,node:null,nodeIndex:s+1,offset:l+1}}return{length:0,node:null,nodeIndex:0,offset:0}}function Ce(e){const t=e.anchor,n=e.focus;let s=!1;try{const e=t.getNode(),i=n.getNode();(!e.isAttached()||!i.isAttached()||o(e)&&t.offset>e.getTextContentSize()||o(i)&&n.offset>i.getTextContentSize())&&(s=!0)}catch(e){s=!0}return s}function Oe(e,t){e.doc.transact(t,e)}function Ke(e,n){const o=n._nodeMap.get(e);if(!o)return void u().selectStart();const s=o.__prev;let i=null;s&&(i=t(s)),null===i&&null!==o.__parent&&(i=t(o.__parent)),null!==i?null!==i&&i.isAttached()?i.selectEnd():Ke(i.__key,n):u().selectStart()}const Me=e=>"UNDEFINED"===e.nodeName,Ee=(e,t,n,o,s,i,r)=>{let l=t.mapping.get(e);if(l&&n&&0===n.size&&!o)return l;const c=Me(e)?h.getType():e.nodeName,a=t.editor._nodes.get(c);if(void 0===a)throw new Error(`$createOrUpdateNodeFromYElement: Node ${c} is not registered`);if(l||(l=new a.klass,n=null,o=!0),o&&l instanceof p){const n=[],o=e=>{if(e instanceof v){const o=Ee(e,t,new Set,!1,s,i,r);null!==o&&n.push(o)}else if(e instanceof N){const o=Ae(e,t,s,i,r);null!==o&&o.forEach(e=>{null!==e&&n.push(e)})}else V(329)};void 0===s||void 0===i?e.toArray().forEach(o):O(e,new K(i.ds,s.sv)).filter(e=>!e._item.deleted||Fe(e._item,s)||Fe(e._item,i)).forEach(o),Pe(l,n)}const f=e.getAttributes(s);Me(e)||void 0===s||(Fe(e._item,s)?Fe(e._item,i)||(f[Je("ychange")]=r?r("added",e._item.id):{type:"added"}):f[Je("ychange")]=r?r("removed",e._item.id):{type:"removed"});const u={...ge(l,t)},g={};for(const e in f)e.startsWith(qe)?g[Ge(e)]=f[e]:u[e]=f[e];if(Te(t,u,l,n),n){const e=Object.keys(g).filter(e=>n.has(Je(e)));if(e.length>0){const t=d(l);for(const n of e)t.updateFromUnknown(n,g[n])}}else d(l).updateFromJSON(g);const _=l.getLatest();return t.mapping.set(e,_),_},Pe=(e,t)=>{const n=e.getChildren(),o=new Set(n.map(e=>e.getKey())),s=new Set(t.map(e=>e.getKey())),i=n.length-1,r=t.length-1;let l=0,c=0;for(;l<=i&&c<=r;){const i=n[l].getKey(),r=t[c].getKey();if(i===r){l++,c++;continue}const a=s.has(i),f=o.has(r);if(!a){if(0===c&&1===e.getChildrenSize())return void e.splice(c,1,t.slice(c));e.splice(c,1,[]),l++;continue}const d=t[c];f?(e.splice(c,1,[d]),l++,c++):(e.splice(c,0,[d]),c++)}const a=l>i,f=c>r;a&&!f?e.append(...t.slice(c)):f&&!a&&e.splice(t.length,e.getChildrenSize()-t.length,[])},Fe=(e,t)=>void 0===t?!e.deleted:t.sv.has(e.id.client)&&t.sv.get(e.id.client)>e.id.clock&&!M(t.ds,e.id),Ae=(e,t,n,s,i)=>{const r=Re(e,n,s,i);let l=t.mapping.get(e)??[];const c=r.map(e=>e.attributes.t??g.getType());if(!(l.length===c.length&&l.every((e,t)=>e.getType()===c[t]))){const e=t.editor._nodes;l=c.map(t=>{const n=e.get(t);if(void 0===n)throw new Error(`$createTextNodesFromYText: Node ${t} is not registered`);const s=new n.klass;if(!o(s))throw new Error(`$createTextNodesFromYText: Node ${t} is not a TextNode`);return s})}for(let e=0;e<r.length;e++){const n=l[e],o=r[e],{attributes:s,insert:i}=o;n.__text!==i&&n.setTextContent(i);const c={...ge(n,t),...s.p},a=Object.fromEntries(Object.entries(s).filter(([e])=>e.startsWith(qe)).map(([e,t])=>[Ge(e),t]));Te(t,c,n,null),d(n).updateFromJSON(a)}const a=l.map(e=>e.getLatest());return t.mapping.set(e,a),a},je=(e,t)=>e instanceof Array?((e,t)=>{const n=new N;return Ue(n,e,t),n})(e,t):((e,t)=>{const n=new v(e.getType()),o={...Be(e,t),...Ve(e)};for(const e in o){const t=o[e];null!==t&&n.setAttribute(e,t)}return e instanceof p?(n.insert(0,De(e).map(e=>je(e,t))),t.mapping.set(n,e),n):n})(e,t),ze=e=>"object"==typeof e&&null!=e,Le=(e,t)=>{const n=Object.keys(e).filter(t=>null!==e[t]);if(null==t)return 0===n.length;let o=n.length===Object.keys(t).filter(e=>null!==t[e]).length;for(let s=0;s<n.length&&o;s++){const i=n[s],r=e[i],l=t[i];o="ychange"===i||r===l||ze(r)&&ze(l)&&Le(r,l)}return o},De=e=>{if(!(e instanceof p))return[];const t=e.getChildren(),n=[];for(let e=0;e<t.length;e++){const s=t[e];if(o(s)){const s=[];for(let n=t[e];e<t.length&&o(n);n=t[++e])s.push(n);e--,n.push(s)}else n.push(s)}return n},Ye=(e,t,n)=>{const o=Re(e);return o.length===t.length&&o.every((e,o)=>{const s=t[o],i=e.attributes.t??g.getType(),r=e.attributes.p??{},l=Object.fromEntries(Object.entries(e.attributes).filter(([e])=>e.startsWith(qe)));return e.insert===s.getTextContent()&&i===s.getType()&&Le(r,Be(s,n))&&Le(l,Ve(s))})},Ie=(e,t,n)=>{if(e instanceof v&&!(t instanceof Array)&&Qe(e,t)){const o=De(t);return e._length===o.length&&Le(e.getAttributes(),{...Be(t,n),...Ve(t)})&&e.toArray().every((e,t)=>Ie(e,o[t],n))}return e instanceof N&&t instanceof Array&&Ye(e,t,n)},$e=(e,t)=>e===t||e instanceof Array&&t instanceof Array&&e.length===t.length&&e.every((e,n)=>t[n]===e),We=(e,t,n)=>{const o=e.toArray(),s=De(t),i=s.length,r=o.length,l=Math.min(r,i);let c=0,a=0,f=!1;for(;c<l;c++){const e=o[c],t=s[c];if(e instanceof E)break;if($e(n.mapping.get(e),t))f=!0;else if(!Ie(e,t,n))break}for(;c+a<l;a++){const e=o[r-a-1],t=s[i-a-1];if(e instanceof E)break;if($e(n.mapping.get(e),t))f=!0;else if(!Ie(e,t,n))break}return{equalityFactor:c+a,foundMappedChild:f}},Ue=(e,t,n)=>{n.mapping.set(e,t);const{nAttrs:o,str:r}=(e=>{let t="",n=e._start;const o={};for(;null!==n;)n.deleted||(n.countable&&n.content instanceof P?t+=n.content.str:n.content instanceof F&&(o[n.content.key]=null)),n=n.right;return{nAttrs:o,str:t}})(e),l=t.map((e,t)=>{const s=e.getType();let i=Be(e,n);return 0===Object.keys(i).length&&(i=null),{attributes:Object.assign({},o,{...s!==g.getType()&&{t:s},p:i,...Ve(e),...t>0&&{i:t}}),insert:e.getTextContent(),nodeKey:e.getKey()}}),c=l.map(e=>e.insert).join(""),a=s();let f;if(i(a)&&a.isCollapsed()){f=0;for(const e of l){if(e.nodeKey===a.anchor.key){f+=a.anchor.offset;break}f+=e.insert.length}}else f=c.length;const{insert:d,remove:u,index:h}=H(r,c,f);e.delete(h,u),e.insert(h,d),e.applyDelta(l.map(e=>({attributes:e.attributes,retain:e.insert.length})))},Re=(e,t,n,o)=>e.toDelta(t,n,o).map(e=>{const t=e.attributes??{};return"ychange"in t&&(t[Je("ychange")]=t.ychange,delete t.ychange),{...e,attributes:t}}),Be=(e,t)=>{const n=ge(e,t),o={};return Object.entries(n).forEach(([t,n])=>{const s=e[t];s!==n&&(o[t]=s)}),o},qe="s_",Je=e=>`s_${e}`,Ge=e=>{if(!e.startsWith(qe))throw new Error(`Invalid state key: ${e}`);return e.slice(qe.length)},Ve=e=>{const t=e.__state;if(!t)return{};const[n={},o]=t.getInternalState(),s={};for(const[e,t]of Object.entries(n))s[Je(e)]=t;for(const[e,t]of o)s[Je(e.key)]=e.unparse(t);return s},He=(e,t,n,o,s)=>{if(t instanceof v&&t.nodeName!==n.getType()&&(!Me(t)||n.getType()!==h.getType()))throw new Error("node name mismatch!");if(o.mapping.set(t,n),t instanceof v){const e=t.getAttributes(),s={...Be(n,o),...Ve(n)};for(const n in s)null!=s[n]?e[n]!==s[n]&&"ychange"!==n&&t.setAttribute(n,s[n]):t.removeAttribute(n);for(const n in e)void 0===s[n]&&t.removeAttribute(n)}const i=De(n),r=i.length,l=t.toArray(),c=l.length,a=Math.min(r,c);let f=0,d=0;for(;f<a;f++){const t=l[f],n=i[f];if(t instanceof E)break;if($e(o.mapping.get(t),n))n instanceof p&&s.has(n.getKey())&&He(e,t,n,o,s);else{if(!Ie(t,n,o))break;o.mapping.set(t,n)}}for(;d+f<a;d++){const t=l[c-d-1],n=i[r-d-1];if(t instanceof E)break;if($e(o.mapping.get(t),n))n instanceof p&&s.has(n.getKey())&&He(e,t,n,o,s);else{if(!Ie(t,n,o))break;o.mapping.set(t,n)}}for(;c-f-d>0&&r-f-d>0;){const n=l[f],a=i[f],u=l[c-d-1],h=i[r-d-1];if(n instanceof N&&a instanceof Array)Ye(n,a,o)||Ue(n,a,o),f+=1;else{let i=n instanceof v&&Qe(n,a),r=u instanceof v&&Qe(u,h);if(i&&r){const e=We(n,a,o),t=We(u,h,o);e.foundMappedChild&&!t.foundMappedChild?r=!1:!e.foundMappedChild&&t.foundMappedChild||e.equalityFactor<t.equalityFactor?i=!1:r=!1}i?(He(e,n,a,o,s),f+=1):r?(He(e,u,h,o,s),d+=1):(o.mapping.delete(t.get(f)),t.delete(f,1),t.insert(f,[je(a,o)]),f+=1)}}const u=c-f-d;if(1===c&&0===r&&l[0]instanceof N?(o.mapping.delete(l[0]),l[0].delete(0,l[0].length)):u>0&&(t.slice(f,f+u).forEach(e=>o.mapping.delete(e)),t.delete(f,u)),f+d<r){const e=[];for(let t=f;t<r-d;t++)e.push(je(i[t],o));t.insert(f,e)}},Qe=(e,t)=>!(t instanceof Array)&&e.nodeName===t.getType(),Xe=y("ychange",{isEqual:(e,t)=>e===t,parse:e=>e??null});function Ze(e){return _(e,Xe)}const et=(e,t=A(e.doc),n=j)=>{const{doc:o}=e;o.gc&&V(325),o.transact(s=>{const i=new z(o);i&&i.dss.forEach(e=>{L(s,e,e=>{})});const r=(e,t)=>({id:t,type:e,user:("added"===e?i.getUserByClientId(t.client):i.getUserByDeletedId(t))??null});e.mapping.clear(),e.editor.update(()=>{u().clear(),Ee(e.root,e,null,!0,t,n,r)})},e)};function tt(e,t){const n=t.collabNodeMap.get(e.key);if(void 0===n)return null;let s=e.offset,i=n.getSharedType();if(n instanceof te){i=n._parent._xmlText;const e=n.getOffset();if(-1===e)return null;s=e+1+s}else if(n instanceof oe&&"element"===e.type){const t=e.getNode();r(t)||V(184);let n=0,i=0,l=t.getFirstChild();for(;null!==l&&i++<s;)o(l)?n+=l.getTextContentSize()+1:n++,l=l.getNextSibling();s=n}return Y(i,s)}function nt(e,t){const{mapping:n}=t,{offset:s}=e,i=e.getNode(),l=n.getSharedType(i);if(void 0===l)return null;if("text"===e.type){o(i)||V(326);let e=i.getPreviousSibling(),t=s;for(;o(e);)t+=e.getTextContentSize(),e=e.getPreviousSibling();return Y(l,t)}if("element"===e.type){r(i)||V(184);let e=0,t=i.getFirstChild();for(;null!==t&&e<s;){if(o(t)){let e=t.getNextSibling();for(;o(e);)e=e.getNextSibling()}e++,t=t.getNextSibling()}return Y(l,e)}return null}function ot(e,t){return D(e,t.doc)}function st(e,t){if(null==e){if(null!=t)return!0}else if(null==t||!I(e,t))return!0;return!1}function it(e,t){return{color:t,name:e,selection:null}}function rt(e,t){const n=e.cursorsContainer;if(null!==n){const e=t.selections,o=e.length;for(let t=0;t<o;t++)n.removeChild(e[t])}}function lt(e,t){const n=t.selection;null!==n&&rt(e,n)}function ct(e,t,n,o,s){const i=e.color,r=document.createElement("span");r.style.cssText=`position:absolute;top:0;bottom:0;right:-1px;width:1px;background-color:${i};z-index:10;`;const l=document.createElement("span");return l.textContent=e.name,l.style.cssText=`position:absolute;left:-2px;top:-16px;background-color:${i};color:#fff;line-height:12px;font-size:12px;padding:2px;font-family:Arial;font-weight:bold;white-space:nowrap;`,r.appendChild(l),{anchor:{key:t,offset:n},caret:r,color:i,focus:{key:o,offset:s},name:l,selections:[]}}function at(e,t,o,s){const i=e.editor,r=i.getRootElement(),l=e.cursorsContainer;if(null===l||null===r)return;const c=l.offsetParent;if(null===c)return;const a=c.getBoundingClientRect(),f=t.selection;if(null===o)return null===f?void 0:(t.selection=null,void rt(e,f));t.selection=o;const d=o.caret,u=o.color,h=o.selections,p=o.anchor,g=o.focus,_=p.key,y=g.key,m=s.get(_),x=s.get(y);if(null==m||null==x)return;let T;if(m===x&&n(m)){T=[i.getElementByKey(_).getBoundingClientRect()]}else{const e=J(i,m,p.offset,x,g.offset);if(null===e)return;T=G(i,e)}const b=h.length,k=T.length;for(let e=0;e<k;e++){const t=T[e];let n=h[e];if(void 0===n){n=document.createElement("span"),h[e]=n;const t=document.createElement("span");n.appendChild(t),l.appendChild(n)}const o=`position:absolute;top:${t.top-a.top}px;left:${t.left-a.left}px;height:${t.height}px;width:${t.width}px;pointer-events:none;z-index:5;`;n.style.cssText=o,n.firstChild.style.cssText=`${o}left:0;top:0;background-color:${u};opacity:0.3;`,e===k-1&&d.parentNode!==n&&n.appendChild(d)}for(let e=b-1;e>=k;e--){const t=h[e];l.removeChild(t),h.pop()}}function ft(e,t){const{anchorPos:n,focusPos:o}=t;let s=null,i=0,r=null,l=0;if(null!==n&&null!==o){const t=ot(n,e),c=ot(o,e);null!==t&&null!==c&&([s,i]=pt(t.type,t.index),[r,l]=pt(c.type,c.index))}return{anchorCollabNode:s,anchorOffset:i,focusCollabNode:r,focusOffset:l}}function dt(e,t){const{anchorPos:n,focusPos:s}=t,i=n?ot(n,e):null,r=s?ot(s,e):null;if(null===i||null===r)return{anchorKey:null,anchorOffset:0,focusKey:null,focusOffset:0};if(ae(e)){const[e,t]=pt(i.type,i.index),[n,o]=pt(r.type,r.index);return{anchorKey:null!==e?e.getKey():null,anchorOffset:t,focusKey:null!==n?n.getKey():null,focusOffset:o}}let[l,c]=gt(e.mapping,i),[a,f]=gt(e.mapping,r);if(a&&l&&(a!==l||f!==c)){const e=a.isBefore(l),t=e?a:l,n=e?f:c;o(t)&&o(t.getNextSibling())&&n===t.getTextContentSize()&&(e?(a=t.getNextSibling(),f=0):(l=t.getNextSibling(),c=0))}return{anchorKey:null!==l?l.getKey():null,anchorOffset:c,focusKey:null!==a?a.getKey():null,focusOffset:f}}function ut(e,t){const n=t.awareness.getLocalState();if(null===n)return;const{anchorKey:o,anchorOffset:r,focusKey:l,focusOffset:c}=dt(e,n);if(null!==o&&null!==l){const e=s();if(!i(e))return;ht(e.anchor,o,r),ht(e.focus,l,c)}}function ht(e,n,s){if(e.key!==n||e.offset!==s){let i=t(n);if(null!==i&&!r(i)&&!o(i)){const e=i.getParentOrThrow();n=e.getKey(),s=i.getIndexWithinParent(),i=e}e.set(n,s,r(i)?"element":"text")}}function pt(e,t){const n=e._collabNode;if(void 0===n)return[null,0];if(n instanceof oe){const{node:e,offset:o}=we(n,t,!0);return null===e?[n,0]:[e,o]}return[null,0]}function gt(e,t){const n=t.type,s=t.index;if(n instanceof v){const t=e.get(n);if(void 0===t)return[null,0];if(!r(t))return[t,s];let i=s,l=0;const c=t.getChildren();for(;i>0&&l<c.length;){const e=c[l];if(i-=1,l+=1,o(e))for(;l<c.length&&o(c[l]);)l+=1}return[t,l]}{const t=e.get(n);if(void 0===t)return[null,0];let o=0,i=s;for(;i>t[o].getTextContentSize()&&o+1<t.length;)i-=t[o].getTextContentSize(),o++;const r=t[o];return[r,Math.min(i,r.getTextContentSize())]}}function _t(e,t){return t.awareness.getStates()}function yt(e,t,n){const{getAwarenessStates:o=_t}=n??{},s=Array.from(o(e,t)),i=e.clientID,r=e.cursors,l=e.editor,c=l._editorState._nodeMap,a=new Set;for(let t=0;t<s.length;t++){const n=s[t],[o,f]=n;if(0!==o&&o!==i){a.add(o);const{name:t,color:n,focusing:s}=f;let i=null,d=r.get(o);if(void 0===d&&(d=it(t,n),r.set(o,d)),s){const{anchorKey:t,anchorOffset:n,focusKey:o,focusOffset:s}=l.read(()=>dt(e,f));if(null!==t&&null!==o)if(i=d.selection,null===i)i=ct(d,t,n,o,s);else{const e=i.anchor,r=i.focus;e.key=t,e.offset=n,r.key=o,r.offset=s}}at(e,d,i,c)}}const f=Array.from(r.keys());for(let t=0;t<f.length;t++){const n=f[t];if(!a.has(n)){const t=r.get(n);void 0!==t&&(lt(e,t),r.delete(n))}}}function mt(e,t,n,o){const s=t.awareness,r=s.getLocalState();if(null===r)return;const{anchorPos:l,focusPos:c,name:a,color:f,focusing:d,awarenessData:u}=r;let h=null,p=null;(null!==o&&(null===l||o.is(n))||null!==n)&&(i(o)&&(ae(e)?(h=tt(o.anchor,e),p=tt(o.focus,e)):(h=nt(o.anchor,e),p=nt(o.focus,e))),(st(l,h)||st(c,p))&&s.setLocalState({...r,anchorPos:h,awarenessData:u,color:f,focusPos:p,focusing:d,name:a}))}function xt(e,t){if(t instanceof W&&function(e,t){const{target:n}=t;if(!n._item||"__state"!==n._item.parentSub||void 0!==ye(n)||!(n.parent instanceof N||n.parent instanceof v||n.parent instanceof w))return!1;const o=me(e,n.parent).getNode();if(o){const e=d(o.getWritable());for(const o of t.keysChanged)e.updateFromUnknown(o,n.get(o))}return!0}(e,t))return;const{target:n}=t,o=me(e,n);if(o instanceof oe&&t instanceof U){const{keysChanged:n,childListChanged:s,delta:i}=t;n.size>0&&o.syncPropertiesFromYjs(e,n),s&&(o.applyChildrenYjsDelta(e,i),o.syncChildrenFromYjs(e))}else if(o instanceof te&&t instanceof W){const{keysChanged:n}=t;n.size>0&&o.syncPropertiesAndTextFromYjs(e,n)}else if(o instanceof Q&&t instanceof R){const{attributesChanged:n}=t;n.size>0&&o.syncPropertiesFromYjs(e,n)}else V(82)}function Tt(e,t,n,o,s=yt){const i=e.editor,r=i._editorState;n.forEach(e=>e.delta),i.update(()=>{for(let t=0;t<n.length;t++){const o=n[t];xt(e,o)}bt(r,e,t),o||T(b)},{onUpdate:()=>{s(e,t),i.update(()=>kt())},skipTransforms:!0,tag:o?x:m})}function bt(e,t,n){const o=s();if(i(o))if(Ce(o)){const r=e._selection;if(i(r)&&(ut(t,n),Ce(o))){Ke(o.anchor.key,e)}mt(t,n,r,s())}else ut(t,n)}function kt(){0===u().getChildrenSize()&&u().append(k())}function St(e,n,i,r,l,c,a,f){Oe(e,()=>{r.read(()=>{if(f.has(m)||f.has(x))return void(a.size>0&&function(e,n){const s=Array.from(n),i=e.collabNodeMap,r=[],l=[];for(let e=0;e<s.length;e++){const n=s[e],c=t(n),a=i.get(n);if(a instanceof te)if(o(c))r.push([a,c.__text]);else{const e=a.getOffset();if(-1===e)continue;const t=a._parent;a._normalized=!0,t._xmlText.delete(e,1),l.push(a)}}for(let e=0;e<l.length;e++){const t=l[e],n=t.getKey();i.delete(n);const o=t._parent._children,s=o.indexOf(t);o.splice(s,1)}for(let e=0;e<r.length;e++){const[t,n]=r[e];t._text=n}}(e,a));if(l.has("root")){const t=i._nodeMap,n=u(),o=e.root;o.syncPropertiesFromLexical(e,n,t),o.syncChildrenFromLexical(e,n,t,l,c)}const r=s(),d=i._selection;mt(e,n,d,r)})})}function Nt(e,t){const{target:n}=t;if(n instanceof v&&t instanceof R)Ee(n,e,t.attributesChanged,t.childListChanged);else if(n instanceof N&&t instanceof U){const t=n.parent;t instanceof v?Ee(t,e,new Set,!0):V(327)}else V(328)}function vt(e,t,n,o,s){const i=e.editor,r=i._editorState;L(o,o.deleteSet,t=>{if(t.constructor===$){const n=t.content.type;n&&e.mapping.delete(n)}}),n.forEach(e=>e.delta),i.update(()=>{for(let t=0;t<n.length;t++){const o=n[t];Nt(e,o)}bt(r,e,t),s||T(b)},{discrete:!0,onUpdate:()=>{yt(e,t),i.update(()=>kt())},skipTransforms:!0,tag:s?x:m})}function wt(e,t){e.mapping.clear();const n=e.editor;n.update(()=>{u().clear(),Ee(e.root,e,null,!0),T(m)},{discrete:!0,onUpdate:()=>{yt(e,t),n.update(()=>kt())},skipTransforms:!0,tag:m})}function Ct(e,t,n,o,i,r,l){(l.has(m)||l.has(x))&&0===r.size||(r.forEach(t=>{e.mapping.deleteNode(t)}),Oe(e,()=>{o.read(()=>{i.has("root")&&He(e.doc,e.root,u(),e,new Set(i.keys()));const o=s(),r=n._selection;mt(e,t,r,o)})}))}const Ot=S("CONNECTED_COMMAND"),Kt=S("TOGGLE_CONNECT_COMMAND"),Mt=S("DIFF_VERSIONS_COMMAND"),Et=S("CLEAR_DIFF_VERSIONS_COMMAND");function Pt(e,t){return new B(t,{trackedOrigins:new Set([e,null])})}function Ft(e,t,n,o,s){e.awareness.setLocalState({anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t})}function At(e,t,n,o,s){const{awareness:i}=e;let r=i.getLocalState();null===r&&(r={anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t}),r.focusing=o,i.setLocalState(r)}export{Ze as $getYChangeState,Et as CLEAR_DIFF_VERSIONS_COMMAND__EXPERIMENTAL,Ot as CONNECTED_COMMAND,Mt as DIFF_VERSIONS_COMMAND__EXPERIMENTAL,Kt as TOGGLE_CONNECT_COMMAND,le as createBinding,ce as createBindingV2__EXPERIMENTAL,Pt as createUndoManager,ft as getAnchorAndFocusCollabNodesForUserState,Ft as initLocalState,et as renderSnapshot__EXPERIMENTAL,At as setLocalStateFocus,yt as syncCursorPositions,St as syncLexicalUpdateToYjs,Ct as syncLexicalUpdateToYjsV2__EXPERIMENTAL,Tt as syncYjsChangesToLexical,vt as syncYjsChangesToLexicalV2__EXPERIMENTAL,wt as syncYjsStateToLexicalV2__EXPERIMENTAL};
