# Generation Brief for Phase T1 — Repository & Environment Bootstrap

*(Derived from the approved Detailed Design for the Internal Document Sharing App — SSR on first load & document view; SPA elsewhere • SurrealDB (schema-full / SurrealKV for dev) • Clerk • Lexical + yjs • TailwindCSS • Effect • MCP: context7/serena • Tests: Vitest + Effect + Chrome DevTools • UTF-8)*

> **Audience:** A capable code-generation agent.
> **Scope of this instruction:** **Only** Task **T1 — Repository & Environment Bootstrap** and the minimal scaffolding that T1 implies. Do **not** implement beyond T1.
> **Prereqs available:** `jj`, `git`, and `Qwik` environment are **already prepared**.
> **Mandatory rules:** Before doing anything, read and obey `/Users/ods/Documents/scio/.serena/memories/rule.md`. Treat it as authoritative for naming, commit style, coding conventions, and any “Definition of Done” (DoD) extensions.

---

## 0. Inputs & Constraints

1. **Design Source of Truth**
   Use the “Detailed Design — Internal Document Sharing Application” provided by the user. Do not introduce extra features. Stay within T1 scope.

2. **MCP Servers**

   * Use **context7** and **serena** as your **only** MCP servers.
   * Use them to: (a) open or search local files (e.g., the `rule.md`); (b) recall prior decisions/progress; (c) fetch non-internet local references.
   * Log each MCP interaction (server, query, result summary) into `docs/dev/mcp_journal.md`.

3. **Repository State**

   * Monorepo is allowed; top-level `repo/` root will be created if absent.
   * `git` and `jj` are ready. Use **jj** for the primary workflow and mirror to `git` only if specified in `rule.md`.

4. **Boundaries (Do not implement in T1)**

   * No business logic APIs, DB migrations application, SSR route handlers, or editor features.
   * No Clerk wiring, yjs WS, or Effect runtime logic beyond placeholders/stubs.
   * No UI screens beyond the minimal “workhell” frame and a placeholder page that renders and builds.

---

## 1. Target Deliverables (T1)

Create the **bare minimum, production-grade skeleton** that the rest of phases can build upon:

1. **Directory Layout (scaffold only)**

   ```

     work/
       web/
         src/
           routes/
             index.tsx                    # temporary welcome page (SSR-friendly)
             api/                         # placeholder only; no logic
           components/
             layout/workhell.tsx          # minimal shell for future menus
           lib/
             effect/runtime.ts            # stub (structured logger/tracer placeholders)
             normalize/nfkc.ts            # stub (function signature only)
             db/surreal.ts                # stub (client factory signature only)
             ids/id.ts                    # stub (URL-safe id generator signature only)
           styles/globals.css             # Tailwind base
         public/.gitkeep
         package.json
         tailwind.config.ts
         postcss.config.cjs
         tsconfig.json
         vite.config.ts
         .env.example
     infra/
       surreal/
         000_namespace_db.surql           # empty file with header comments only (no schema yet)
         010_tables.surql                 # ditto
         020_fields_indexes.surql         # ditto
     tests/
       unit/.gitkeep
       integration/.gitkeep
       devtools/.gitkeep
     docs/
       dev/adr/000-bootstrap.md
       dev/mcp_journal.md
       README.md
   ```

   * All **files must be UTF-8** with LF line endings.

2. **NPM Scripts (work/web/package.json)**

   * `dev`: Qwik dev server
   * `build`: production build
   * `preview`: serve built output
   * `test`: run Vitest (will pass with zero tests)
   * `typecheck`: `tsc --noEmit`
   * `lint`: if `rule.md` defines linters, add stubs that don’t fail when rules are absent

3. **Tailwind Setup**

   * Configure `tailwind.config.ts`, `postcss.config.cjs`, and `styles/globals.css` with a neutral, accessible base.

4. **Environment Template**

   * Create `.env.example` with placeholders for **Clerk**, **SurrealDB NS/DB/URL**, and **TLS** cert paths.
   * Do **not** supply real secrets.

5. **Minimal SSR-friendly Page**

   * `routes/index.tsx`: renders the app shell with a visible “Bootstrap OK” message and build metadata (commit/branch/date) pulled from env at build time if available.

6. **Effect Runtime Stub**

   * `lib/effect/runtime.ts`: export **typed** no-op logger/tracer/error helpers with TODO markers (no external deps).

7. **Docs**

   * `docs/dev/adr/000-bootstrap.md`: records why Qwik/Tailwind/Effect stubs were chosen and T1 boundaries.
   * `docs/dev/mcp_journal.md`: log each MCP query (context7/serena), date, purpose, one-line result.

8. **Version Control**

   * Create an initial **jj change** with a conventional message:
     `chore(bootstrap): scaffold monorepo, qwik app, tailwind, env template, docs`
   * If `rule.md` prescribes message format, follow it instead.

---

## 2. Step-by-Step Plan

> Perform each step atomically. After each step, run **typecheck** and **build**. If a step fails, fix before proceeding.

### Step A — Read Rules (MCP: serena)

1. Use MCP **serena** to open:
   `/Users/ods/Documents/scio/.serena/memories/rule.md`
2. Extract and note:

   * Branch/commit conventions (jj + git), directory naming, file headers, copyright.
   * Code style (TS strictness, ESLint/Biome if any), test/lint gates, CI expectations.
3. Append a summary to `docs/dev/adr/000-bootstrap.md` and **cite exact sections/lines**.

### Step B — Create Repository Skeleton

1. Create directories exactly as listed in **Deliverables/1**.
2. Add `.gitkeep` where denoted.
3. Ensure empty `.surql` files contain a header banner:

   ```sql
   -- Phase T1 placeholder; do not apply in this phase.
   -- Detailed Design: schema-full / SurrealKV for dev.
   ```
4. Add `README.md` at `repo/docs/README.md` with:

   * Project purpose (from Detailed Design)
   * Build/run commands (dev/build/preview)
   * Phase boundaries (T1 only)

### Step C — Initialize Qwik App (work/web)

1. Create `package.json` with:

   * `"type": "module"`
   * scripts: `dev`, `build`, `preview`, `test`, `typecheck`, `lint`
   * deps: `@builder.io/qwik`, `@builder.io/qwik-city`, `vite`, `typescript`, `vitest`, `@types/node`, `tailwindcss`, `postcss`, `autoprefixer`
   * **Do not** add business deps (Clerk, yjs, Effect) in T1.
2. `tsconfig.json`:

   * `strict: true`, `noImplicitAny: true`, module resolution suitable for Qwik/Vite.
3. `vite.config.ts`: minimal Qwik City configuration.
4. `tailwind.config.ts` & `postcss.config.cjs`: standard minimal.
5. `styles/globals.css`: include Tailwind base/components/utilities and a minimal accessible color reset.

### Step D — Minimal SSR-Friendly Route & Shell

1. `src/components/layout/workhell.tsx` (TSX):

   * Render a header with app title and placeholder nav slots (no logic).
2. `src/routes/index.tsx`:

   * SSR-friendly component showing:

     * “Bootstrap OK”
     * Build info: `COMMIT_SHA`, `BUILD_DATE`, `BRANCH` (read from `import.meta.env` if present)
3. Import `globals.css` in the root entry (Qwik app setup).

### Step E — Stubs Required by Later Phases

1. `lib/effect/runtime.ts`:

   ```ts
   export type LogFields = Record<string, unknown>;
   export const logInfo = (msg: string, fields?: LogFields) => { /* noop T1 */ };
   export const logError = (msg: string, err?: unknown, fields?: LogFields) => { /* noop T1 */ };
   export const trace = <T>(name: string, fn: () => T): T => fn(); // noop T1
   ```
2. `lib/normalize/nfkc.ts`:

   ```ts
   export function normalizeQueryNFKCCasefold(input: string): string {
     // T1 stub — implement in a later task
     return input;
   }
   ```
3. `lib/db/surreal.ts`:

   ```ts
   export type SurrealConfig = { url: string; namespace: string; database: string };
   export async function getDbClient(_cfg: SurrealConfig) {
     // T1 stub — return a mock/sentinel; no network
     return {};
   }
   ```
4. `lib/ids/id.ts`:

   ```ts
   export function generateUrlSafeId(): string {
     // T1 stub — real impl (ULID/UUID-url-safe) comes later
     return 'id-' + Math.random().toString(36).slice(2, 10);
   }
   ```

### Step F — Environment Template

Create `work/web/.env.example`:

```
# All values are placeholders; do not commit secrets.
# UTF-8 only.

# Clerk (to be wired in later phases)
CLERK_PUBLISHABLE_KEY=
CLERK_SECRET_KEY=

# SurrealDB (dev: SurrealKV path or remote URL)
SURREAL_URL=
SURREAL_NAMESPACE=docs
SURREAL_DATABASE=intranet

# TLS (dev self-signed paths)
TLS_CERT_PATH=
TLS_KEY_PATH=

# Build metadata (injected by CI or local script)
COMMIT_SHA=
BRANCH=
BUILD_DATE=
```

### Step G — Documentation

1. `docs/dev/adr/000-bootstrap.md` should include:

   * Goal of T1
   * Dependencies chosen and **why they are stubs** now
   * Rule summary from `rule.md`
   * Out-of-scope list for T1
2. `docs/dev/mcp_journal.md`: initialize with a table header:

   ```
   | Date (JST) | Server  | Action                 | Query/Path                                   | Result Summary |
   |------------|---------|------------------------|-----------------------------------------------|----------------|
   ```

### Step H — Build, Typecheck, Preview

* At repo root:

  * `bun i` (or tool dictated by `rule.md`)
  * `bun -C work/web typecheck`
  * `bun -C work/web build`
  * `bun -C work/web preview` (confirm page renders “Bootstrap OK”)

### Step I — Version Control (jj)

1. Create a feature change:

   ```
   jj new -m "chore(bootstrap): scaffold monorepo, qwik app, tailwind, env template, docs"
   ```

   *(If `rule.md` prescribes a different format, use that.)*
2. Add files and commit via jj as per the rules.
3. If mirroring to git is required by `rule.md`, perform the mirror push.

---

## 3. Quality Gates (T1 Definition of Done)

* [x] **Rule compliance:** `rule.md` is read and summarized in `adr/000-bootstrap.md`; naming/commit style matches the rules.
* [x] **UTF-8 everywhere**; no secrets checked in.
* [ ] **Build passes** (`work/web build`) and **preview renders** “Bootstrap OK” — build succeeds via `npm run build`, preview command is blocked locally (`listen EPERM 127.0.0.1:4173`); rerun `npm run build.preview && npm run preview` on the host to validate.
* [x] **Minimal SSR** page exists without runtime errors.
* [x] **Tailwind** compiles and `globals.css` is loaded.
* [x] **Effect**, **normalize**, **db**, **ids** stubs compile (no dead imports).
* [x] **.env.example** present with all keys.
* [x] **Docs** present (ADR + MCP journal).
* [x] **jj** change with conventional message exists and files are tracked.

---

## 4. What NOT to do in T1

* Do not implement API routes, Clerk integration, yjs WS, or DB migrations execution.
* Do not add production dependencies beyond what is strictly needed to compile/run a static “Bootstrap OK” page.
* Do not introduce features or files not listed in the Detailed Design.

---

## 5. MCP Usage Requirements

* Use **serena** MCP to **open and summarize** `rule.md`.
* Use **context7** MCP for any local project context retrieval if needed (e.g., prior ADRs).
* After each MCP call, append a row to `docs/dev/mcp_journal.md` with date (JST), server, action, path/query, and a one-line summary.

---

## 6. Acceptance Checklist (for the Agent to print at the end)

* [x] Directories/files created exactly as specified.
* [ ] `work/web` builds and previews with SSR-friendly page — build OK; preview blocked locally with `listen EPERM 127.0.0.1:4173`, rerun `npm run build.preview && npm run preview` outside the sandbox.
* [x] Tailwind and CSS pipeline in place.
* [x] Stubs compile with strict TS settings.
* [x] `.env.example` complete.
* [x] ADR and MCP journal created and populated.
* [x] `jj` change committed per rules.

---

### Final Note

If any requirement conflicts with `/Users/ods/Documents/scio/.serena/memories/rule.md`, **the rule file wins**. Update the ADR and follow the rule-prescribed commit/message/branching immediately.
